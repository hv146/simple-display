<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <meta name="viewport", content="width=device-width, initial-scale=1.0">   
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Simple Display">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="styles.css">     
    <title>Wiim Display</title>
</head>
<body>
        <div id="active-layout" class="layout">
      <section id="main">
        <img id="albumArt" class="album-art" src="./artwork-placeholder.png" alt="Album Art" class="lazyload" width="550" height="550">
        <div class="songInfo">
            <div class="song-duration" id="songLength">
              <span id="currentPos">00:00</span>
              <span id="timeSeparator">/</span>
              <span class="duration" id="duration">00:00</span>
            </div>
            <audio id="jellyfin-audio" class="audio"></audio>
            <div class="track-title" id="title">Unknown</div>
            <div class="artist-name" id="artist">Unknown</div>
            <span class="separator">•••</span>
            <div class="album-name" id="album">Unknown</div>
        </div>
          <div class="playbackControl">
            <button id="previousButton" class="button">
              <i class="fa fa-step-backward"></i></button>
            <button id="playButton" class='button'>
              <i class="fa fa-play"></i>
              <i class="fa fa-pause"></i>
            </button>
            <button id="nextButton" class="button">
              <i class="fa fa-step-forward"></i>
            </button>
            <button id="shuffle" class="button">
                <i class="fa fa-random"></i>
            </button>
            <button id="switchLayout" class="button">
              <i class="fa fa-power-off"></i>
            </button>
        </div>
      </div>
      <div id="idle-layout" class="layout hidden">
            <div class="idle-container">
                <div class="stat_box total_play">
                  <div class="header">Total Played</div>
                  <div id="total-num" class="scrobbles"></div>
                </div>
                <div class="stat_box last_played">
                  <div class="header">Last Played</div>
                  <div class="play_box">
                    <div id="lastest-track" class="track"></div>
                    <div id="lastest-artist" class="artist"></div>
                  </div>
                </div>
                  <div class="list">
                <div class="preset-dropdown">
            <button onclick="dropdown()" class="button">Presets</button>
              <div class="presets" id="presets">
                <div class="preset-container">
                  <button id="presetBtn" class="button">1</button>
                  <button id="presetBtn" class="button">2</button>
                  <button id="presetBtn" class="button">3</button>
                  <button id="presetBtn" class="button">4</button>
                  <button id="presetBtn" class="button">5</button>
                  <button id="presetBtn" class="button">6</button>
                  <button id="presetBtn" class="button">7</button>
                  <button id="presetBtn" class="button">8</button>
                  <button id="presetBtn" class="button">9</button>
                  <button id="presetBtn" class="button">10</button>
                  <button id="presetBtn" class="button">11</button>
                  <button id="presetBtn" class="button">12</button>
                </div>
              </div>
          </div>

                </div>
                  <div id="albums-list"class="albums">
                  <img class="top_albums" id="top_albums" src="">
                  </div>
                </div>

      </div>
      

      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>

    <script>

      let currentLayout = "idle";
      let songHistory  = {};
      let currentSong = {};
      let songDuration = "";
      let currPos = "";
      let localMode = false; 


      function dropdown() {
        document.getElementById("presets").classList.toggle("show");
      }

      $(document).ready(function() {

       
        let socket = new WebSocket("ws://10.0.0.149:8080/ws"); //establish socket connection
        
        const prevButton = document.getElementById("previousButton");

        prevButton.addEventListener('click', function() {
            newSong = true;
            socket.send("previous")
        });

        const nextButton = document.getElementById("nextButton");

        nextButton.addEventListener('click', function() {
            newSong = true;
            socket.send("next")
        });

        const playButton = document.getElementById("playButton");

        playButton.addEventListener('click', function() {
          pause = true;
          socket.send("onepause");
        }); 
        
        const presetBtns = document.querySelectorAll("#presetBtn");
        
        presetBtns.forEach (preset => {
          preset.addEventListener('click', () => {
            socket.send(preset.textContent);
            console.log(preset.textContent);
          })
        });

        const shuffleBtn = document.getElementById("shuffle");

        shuffleBtn.addEventListener('click', () => {
          socket.send("shuffle");
        });
        const switchBtn = document.getElementById("switchLayout");
        switchBtn.addEventListener('click', () => {
          socket.send("stop");
          socket.send("requestHistory");
          currentLayout="idle";
        });
        // Socket functionallity 

        socket.onopen = function(event) {
          console.log("Connected to Websocket");
          socket.send("stop");
          socket.send("requestHistory");
        };

        //handle data sending to client from server
        socket.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.status) {
              if (data.idleTimer == 10000) {
                socket.send("requestHistory");
                currentLayout = "idle";
              }     
              if (data.idleTimer == 50000) {
                console.log("stop music")
                socket.send("stop");
              }
              if (data.totlen != 0) {
                songDuration = data.totlen;
              }
              document.getElementById("currentPos").textContent= formatDuration(data.curpos);
           } 
            if (data.metaData){
              currentSong = data.metaData
              updateUI(currentSong)
            }
            if (data.type == "history" && currentLayout =="idle" ) {
              document.getElementById("active-layout").style.display = "none"; //hide active layout
              document.getElementById("idle-layout").style.display = "block"; //unhide active layout
              renderIdleLayout(data.Songs)
            }
            if (data.status == "play" && currentLayout == "idle") {//update from pause to play
              document.getElementById("idle-layout").style.display = "none"; //hide active layout
              document.getElementById("active-layout").style.display = "block"; //unhide active layout
              currentLayout = "active"
              updateUI(currentSong)
            }
        };

        socket.onclose = function(event) {
          console.log("Disconnected from Websocket")
        };
        
      function formatDuration(ms){
          let separator = ":"
          if (ms == 0){
            return
          }
          let min = Math.floor((ms / 1000) / 60);
          if (min == 0) {
            min = "00"
          } 
          let s = Math.floor((ms / 1000) % 60);
          if (s < 10) {
            separator += "0"
          }
          return min + separator + s
      }
                   
        function updateUI(song) {
            document.getElementById("duration").textContent = formatDuration(songDuration);
            document.getElementById("title").textContent = song.title.toUpperCase();
            document.getElementById("album").textContent = song.album;
            document.getElementById("albumArt").src = song.albumArtURI;
            document.getElementById("artist").textContent = song.artist;
             ;
            // update background color
            const colorThief = new ColorThief()
            var imageURL = document.getElementById("albumArt").src;
            const img = new Image();
            img.crossOrigin = 'Anonymous'
            img.onload = function () {
            // Make sure image is finished loading
              if (img.complete) {
                const palette = colorThief.getPalette(img)
              //Sets background color to dominant color
                const bestColor = findBestBackgroundColor(palette)
                document.body.style.backgroundColor = `rgb(${bestColor.join(",")})`; 
              } else {
                image.addEventListener('load', function() {
                  colorThief.getColor(img);
                });
              }
            }
            img.src = imageURL;
        }
    function findBestBackgroundColor(palette) {
      const sortedByDarkness = palette.sort((a, b) => getBrightness(a) - getBrightness(b));
      
      // Find color that's dark but not black, bright but not white
      return sortedByDarkness.find(color => {
          const brightness = getBrightness(color);
          return brightness > 30 && brightness < 150; 
      }) || sortedByDarkness[Math.floor(sortedByDarkness.length / 2)];
    }
    
    function getBrightness(rgbArray) {
      const [r, g, b] = rgbArray;
      // Standard luminance calculation
      return (r * 0.299 + g * 0.587 + b * 0.114);
    }




    function renderIdleLayout(songHistory) { //render Idle layout
      document.body.style.backgroundColor = `rgb(15,14,14)`; 
      const container = document.getElementById('container');

          trackData = songHistory
          // Get the most recent track (last played)
          const lastTrack = trackData.length > 0 ? trackData[trackData.length - 1].metaData : null;
          const trackNameOG = lastTrack?.title || 'Unknown Track';
          const trackName = trackNameOG.toUpperCase()
          const artistNameOG = lastTrack?.artist || 'Unknown Artist';
          const artistName = artistNameOG.toUpperCase()
          const totalSongPlayed = trackData.length 
          
          // Get last 18 unique albums (by album name)
          const seenAlbums = new Set();
          const last24Albums = [];
          // Go through tracks from most recent to oldest
          for (let i = trackData.length - 1; i >= 0 && last24Albums.length < 24; i--) {
              const track = trackData[i].metaData;
              const album = track.album;
              const albumArt = track.albumArtURI;
              
              // Only add if we haven't seen this album yet and it has valid data
              if (album && albumArt && !seenAlbums.has(album)) {
                  seenAlbums.add(album);
                  last24Albums.push({
                      name: album,
                      image: albumArt,
                      artist: track.artist
                  });
              }
          }
          // Generate album images HTML
          const albumsHTML = last24Albums.map(album => 
              `<img class="top_albums" id="top_albums" src="${album.image}" alt="${album.name}" title="${album.name} by ${album.artist}">`
          ).join('');
          document.getElementById('lastest-track').textContent = trackName;
          document.getElementById('total-num').textContent = totalSongPlayed;
          document.getElementById('lastest-artist').textContent = artistName;
          const albums = document.querySelector('.albums')
          albums.innerHTML = albumsHTML;
      }                 
                
  }); 
    
  </script>
</body>
</html>

